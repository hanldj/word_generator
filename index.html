<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>點陣字生成器 (可自訂大小)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    textarea {
      width: 100%;
      height: 300px;
      font-family: monospace;
      white-space: pre;
    }
    label, select, input {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h2>點陣字生成器 - 可自訂矩陣大小 (極限壓縮)</h2>
  <label for="inputText">輸入文字：</label>
  <input type="text" id="inputText" value="1">

  <label for="sizeSelect">點陣大小：</label>
  <select id="sizeSelect">
    <option value="16">16x16</option>
    <option value="24" selected>24x24</option>
    <option value="32">32x32</option>
    <option value="64">64x64</option>
  </select>

  <button onclick="generateMatrix()">生成</button>

  <h3>結果：</h3>
  <textarea id="output" readonly></textarea>

  <h3>對應 0/1 點陣：</h3>
  <textarea id="binaryOutput" readonly></textarea>

  <h3>還原 Run-Length 字串：</h3>
  <label for="decodeSize">點陣高度：</label>
  <input type="number" id="decodeSize" value="24">
  <label for="decodeType">類型：</label>
  <select id="decodeType">
    <option value="full">全形</option>
    <option value="half">半形</option>
  </select>
  <br><br>
  <label for="encodedInput">輸入壓縮字串：</label>
  <textarea id="encodedInput"></textarea>
  <button onclick="decodeRLE()">還原</button>

  <h3>還原結果（0/1 點陣）：</h3>
  <textarea id="decodedOutput" readonly></textarea>

  <h3>手動輸入 0/1 點陣轉壓縮：</h3>
  <label for="manualInput">輸入 0/1 點陣：</label>
  <textarea id="manualInput"></textarea>
  <button onclick="encodeManualInput()">壓縮</button>
  <textarea id="manualOutput" readonly></textarea>

  <h3>判斷全形或半形：</h3>
  <label for="typeCheckInput">輸入文字：</label>
  <input type="text" id="typeCheckInput" value="中文A123">
  <button onclick="checkCharacterTypes()">判斷</button>
  <textarea id="typeCheckResult" readonly></textarea>

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    function runLengthEncode(line) {
      let encoded = '';
      let count = 1;
      for (let i = 1; i <= line.length; i++) {
        if (line[i] === line[i - 1]) {
          count++;
        } else {
          while (count > 0) {
            let chunk = Math.min(count, 26);
            let char = String.fromCharCode(96 + chunk);
            if (line[i - 1] === '1') {
              encoded += '1' + char;
            } else {
              encoded += char;
            }
            count -= chunk;
          }
          count = 1;
        }
      }
      return encoded;
    }

    function decodeRLE() {
      const encoded = document.getElementById("encodedInput").value.trim();
      const height = parseInt(document.getElementById("decodeSize").value);
      const type = document.getElementById("decodeType").value;
      const width = type === 'half' ? Math.floor(height / 2) : height;
      const output = document.getElementById("decodedOutput");
      let result = '';
      let i = 0;
      while (i < encoded.length) {
        let char = encoded[i];
        if (char === '1') {
          i++;
          let runChar = encoded[i];
          let count = runChar.charCodeAt(0) - 96;
          result += '1'.repeat(count);
        } else {
          let count = char.charCodeAt(0) - 96;
          result += '0'.repeat(count);
        }
        i++;
      }

      let matrix = '';
      for (let row = 0; row < result.length; row += width) {
        matrix += result.slice(row, row + width) + '\n';
      }
      output.value = matrix;
    }

    function encodeManualInput() {
      const input = document.getElementById("manualInput").value.trim();
      const lines = input.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const joined = lines.join("");
      const result = runLengthEncode(joined);
      document.getElementById("manualOutput").value = result;
    }

    function isFullWidth(char) {
      return char.charCodeAt(0) > 255;
    }

    function generateMatrix() {
      const text = document.getElementById('inputText').value;
      const baseSize = parseInt(document.getElementById('sizeSelect').value);
      const output = document.getElementById('output');
      const binaryOutput = document.getElementById('binaryOutput');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      let result = "";
      let binaryBlock = "";

      for (const char of text) {
        const isFull = isFullWidth(char);
        const width = isFull ? baseSize : Math.floor(baseSize / 2);
        const height = baseSize;

        canvas.width = width;
        canvas.height = height;

        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, width, height);

        ctx.fillStyle = "black";
        ctx.font = `${baseSize - 4}px sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(char, width / 2, height / 2);

        const imageData = ctx.getImageData(0, 0, width, height).data;
        let line = "";
        let binaryLines = [];

        for (let y = 0; y < height; y++) {
          let row = "";
          for (let x = 0; x < width; x++) {
            const index = (y * width + x) * 4;
            const r = imageData[index];
            const g = imageData[index + 1];
            const b = imageData[index + 2];
            const avg = (r + g + b) / 3;
            row += avg < 128 ? "1" : "0";
          }
          binaryLines.push(row);
          line += row;
        }
        binaryBlock += binaryLines.join("\n") + "\n";
        result += runLengthEncode(line) + "\n";
      }
      output.value = result;
      binaryOutput.value = binaryBlock;
    }

    function checkCharacterTypes() {
      const input = document.getElementById("typeCheckInput").value;
      const resultArea = document.getElementById("typeCheckResult");
      let result = '';
      for (const char of input) {
        result += isFullWidth(char) ? '全' : '半';
        result += '\n';
      }
      resultArea.value = result;
    }
  </script>
</body>
</html>
